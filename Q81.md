## SQL Interview Question 81

#### Problem Statement

<bold>Linkedin SQL Interview Question</bold>

There is a table of employee location information called emp_details. Each record
contains a person's name and city where they live. Write a query to return a list of
teams.

Teams are formed within these rules:

 1. Team members must live in the city they represent.
 2. For each city, create teams of 3 until there are fewer than 3 who are
 unassigned.
 3. When there are fewer than 3 people unassigned in a city, they form a team.

Report Requirements -

 1. There should be 3 columns: city name, a comma-delimited list of upto 3 players
 and the team's name.
 2. The city should be ordered alphabetically
 3. Players are selected in the order they occur in the table.
 4. Player names should be ordered alphabetically within the comma-delimited list.
 5. Team names are 'Team' plus a number. For example, the first row's team is
 Team1, then Team2 and so on through Team20. Only show the first 20 rows.

#### Schema setup

```sql
CREATE TABLE emp_details (
    emp_name VARCHAR(10),
    city VARCHAR(15)
);

-- Insert sample data
INSERT INTO emp_details (emp_name, city) VALUES
('Sam', 'New York'),
('David', 'New York'),
('Peter', 'New York'),
('Chris', 'New York'),
('John', 'New York'),
('Steve', 'San Francisco'),
('Rachel', 'San Francisco'),
('Robert', 'Los Angeles');
```

#### Expected Output

| city          | team             | team_name |
|---------------|------------------|-----------|
| Los Angeles   | Robert           | Team1     |
| New York      | David,Peter,Sam  | Team2     |
| New York      | Chris,John       | Team3     |
| San Francisco | Rachel,Steve     | Team4     |

<details>
<summary><strong>Solution</strong></summary>

```sql
WITH cte1 AS (
    SELECT 
        emp_name,
        city,
        ROW_NUMBER() OVER (
            PARTITION BY city 
            ORDER BY city
        ) AS rn
    FROM emp_details
),
cte2 AS (
    SELECT 
        emp_name,
        city,
        CEILING(rn / 3) AS group_flag
    FROM cte1
)
SELECT 
    city,
    GROUP_CONCAT(emp_name ORDER BY emp_name) AS team,
    CONCAT('Team', ROW_NUMBER() OVER()) AS team_name
FROM cte2
GROUP BY city, group_flag;
```
</details>
