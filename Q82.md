## SQL Interview Question 82

#### Problem Statement

<bold>Blinkit SQL Interview Question</bold>

You are given an Orders table with the following columns:
 - Customer id: ID of the customer
 - Order_date: Date when the order was placed
 - coupon_code: Coupon code used in the order (can be Null if no coupon was applied)

We want an SQL query to return the number of new customers who satisfy all of the following conditions:
  1. They place orders in each of their first 3 consecutive months since their very first order.
  2. The number of orders in the second month is exactly double the number of orders in the first month. 
  3. The number of orders in the third month is exactly triple the number of orders in the first month.
  4. Their last order (latest by date) was placed with a coupon code (i.e., Coupon Code is not NULL)

#### Schema setup

```sql
CREATE TABLE Orders (
    customer_id INT,
    order_date DATE,
    coupon_code VARCHAR(50)
);

INSERT INTO Orders VALUES (1, '2025-01-10', NULL);
INSERT INTO Orders VALUES (1, '2025-02-05', NULL);
INSERT INTO Orders VALUES (1, '2025-02-20', NULL);
INSERT INTO Orders VALUES (1, '2025-03-01', NULL);
INSERT INTO Orders VALUES (1, '2025-03-10', NULL);
INSERT INTO Orders VALUES (1, '2025-03-15', 'DISC10');
INSERT INTO Orders VALUES (2, '2025-02-02', NULL);
INSERT INTO Orders VALUES (2, '2025-02-05', NULL);
INSERT INTO Orders VALUES (2, '2025-03-05', NULL);
INSERT INTO Orders VALUES (2, '2025-03-18', NULL);
INSERT INTO Orders VALUES (2, '2025-03-20', NULL);
INSERT INTO Orders VALUES (2, '2025-03-22', NULL);
INSERT INTO Orders VALUES (2, '2025-04-02', NULL);
INSERT INTO Orders VALUES (2, '2025-04-10', NULL);
INSERT INTO Orders VALUES (2, '2025-04-15', 'DISC20');
INSERT INTO Orders VALUES (2, '2025-04-16', NULL);
INSERT INTO Orders VALUES (2, '2025-04-18', NULL);
INSERT INTO Orders VALUES (2, '2025-04-20', 'DISC20');
INSERT INTO Orders VALUES (3, '2025-03-05', NULL);
INSERT INTO Orders VALUES (3, '2025-04-10', NULL);
INSERT INTO Orders VALUES (3, '2025-05-15', 'DISC30');
INSERT INTO Orders VALUES (4, '2025-02-01', NULL);
INSERT INTO Orders VALUES (4, '2025-04-05', 'DISC40');
INSERT INTO Orders VALUES (5, '2025-01-03', NULL);
INSERT INTO Orders VALUES (5, '2025-02-05', NULL);
INSERT INTO Orders VALUES (5, '2025-02-15', NULL);
INSERT INTO Orders VALUES (5, '2025-03-01', NULL);
INSERT INTO Orders VALUES (5, '2025-03-08', 'DISC50');
INSERT INTO Orders VALUES (5, '2025-03-20', NULL);
INSERT INTO Orders VALUES (6, '2025-01-05', NULL);
INSERT INTO Orders VALUES (6, '2025-03-02', NULL);
INSERT INTO Orders VALUES (6, '2025-03-15', NULL);
INSERT INTO Orders VALUES (6, '2025-05-05', NULL);     
INSERT INTO Orders VALUES (6, '2025-05-10', NULL);     
INSERT INTO Orders VALUES (6, '2025-05-25', 'DISC60');
```

#### Expected Output

| no_of_customers |
|-----------------|
|               2 |

<details>
<summary><strong>Solution</strong></summary>

```sql
WITH cte1 AS (
    SELECT
        customer_id,
        DATE_FORMAT(order_date, '%Y-%m-01') AS order_month,
        MIN(DATE_FORMAT(order_date, '%Y-%m-01')) OVER (PARTITION BY customer_id) AS first_order_month,
        LAST_VALUE(coupon_code) OVER (
            PARTITION BY customer_id 
            ORDER BY order_date 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
        ) AS last_coupon
    FROM Orders
    ORDER BY customer_id, order_month
),

cte_2 AS (
    SELECT
        customer_id,
        order_month,
        first_order_month,
        TIMESTAMPDIFF(MONTH, first_order_month, order_month) + 1 AS orders_month
    FROM cte1
    WHERE last_coupon IS NOT NULL
    HAVING orders_month IN (1, 2, 3)
),

cte_3 AS (
    SELECT
        customer_id,
        SUM(CASE WHEN orders_month = 1 THEN 1 ELSE 0 END) AS first_month_orders,
        SUM(CASE WHEN orders_month = 2 THEN 1 ELSE 0 END) AS second_month_orders,
        SUM(CASE WHEN orders_month = 3 THEN 1 ELSE 0 END) AS third_month_orders
    FROM cte_2
    GROUP BY customer_id
    HAVING COUNT(DISTINCT orders_month) = 3
)

SELECT
    COUNT(customer_id) AS no_of_customers
FROM cte_3
WHERE 
    second_month_orders = first_month_orders * 2 
    AND third_month_orders = first_month_orders * 3;
```
</details>
